<!DOCTYPE html>
<html>
<head>
  <title>TypeScript Recorder Demo</title>
  <style>
    body { margin: 0; }
    #editor-container { 
      width: 100vw; 
      height: 100vh;
    }
    .controls {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #333;
      padding: 10px;
      border-radius: 4px;
    }
    button {
      margin: 0 4px;
      padding: 6px 12px;
    }
    .playback-controls {
      margin-top: 10px;
    }
    .playback-controls label {
      margin-right: 10px;
    }
    .playback-controls input {
      width: 60px;
    }
  </style>
</head>
<body>
  <div id="editor-container"></div>
  <div class="controls">
    <button id="startBtn">Start Recording</button>
    <button id="stopBtn" disabled>Stop Recording</button>
    <button id="downloadBtn" disabled>Download Recording</button>
    <button id="playBtn" disabled>Play Recording</button>
    <div class="playback-controls">
      <label>Speed: <input type="number" id="speedInput" value="1" min="0.1" max="10" step="0.1"></label>
      <label>Threshold: <input type="number" id="thresholdInput" value="500" min="0" max="5000" step="100"></label>
    </div>
  </div>

  <script src="https://unpkg.com/monaco-editor@0.45.0/min/vs/loader.js"></script>
  <script type="module">
    // Initialize Monaco and setup demo
    async function initDemo() {
      // Configure Monaco
      require.config({
        paths: {
          vs: 'https://unpkg.com/monaco-editor@0.45.0/min/vs'
        }
      });

      window.MonacoEnvironment = {
        getWorkerUrl: function(moduleId, label) {
          const base = 'https://unpkg.com/monaco-editor@0.45.0/min/vs';
          if (label === 'typescript' || label === 'javascript') {
            return `${base}/language/typescript/ts.worker.js`;
          }
          return `${base}/base/worker/workerMain.js`;
        }
      };

      // Load Monaco
      await new Promise(resolve => require(['vs/editor/editor.main'], resolve));
      
      // Load monaco-recorder
      const { createMonacoRecorder } = await import('../../monaco-recorder.js');
      // Configure TypeScript
      monaco.languages.typescript.typescriptDefaults.setCompilerOptions({
        target: monaco.languages.typescript.ScriptTarget.ESNext,
        module: monaco.languages.typescript.ModuleKind.ESNext,
        moduleResolution: monaco.languages.typescript.ModuleResolutionKind.NodeJs,
        allowJs: true,
        allowNonTsExtensions: true,
        allowSyntheticDefaultImports: true,
        noEmit: true,
        lib: ['esnext', 'dom']
      });

      monaco.languages.typescript.typescriptDefaults.setDiagnosticsOptions({
        noSemanticValidation: false,
        noSyntaxValidation: false,
        noSuggestionDiagnostics: false,
        diagnosticCodesToIgnore: [8006]
      });

      const model = monaco.editor.createModel(
        '// Type your TypeScript code here\n\ninterface User {\n  name: string;\n  age: number;\n}\n\nclass UserImpl implements User {\n  constructor(\n    public name: string,\n    public age: number\n  ) {}\n\n  greet() {\n    return `Hello, I am ${this.name} and I am ${this.age} years old`;\n  }\n}\n',
        'typescript',
        monaco.Uri.parse('file:///workspace.ts')
      );

      const editor = monaco.editor.create(document.getElementById('editor-container'), {
        model: model,
        theme: 'vs-dark',
        minimap: { enabled: false },
        fontSize: 14
      });

      // Initialize recorder with editor and monaco
      const recorder = createMonacoRecorder(editor, monaco);
      let recording = null;
      let startTime = 0;

      const startBtn = document.getElementById('startBtn');
      const stopBtn = document.getElementById('stopBtn');
      const downloadBtn = document.getElementById('downloadBtn');
      const playBtn = document.getElementById('playBtn');
      const speedInput = document.getElementById('speedInput');
      const thresholdInput = document.getElementById('thresholdInput');

      startBtn.onclick = async () => {
        startTime = Date.now();
        await recorder.start();
        startBtn.disabled = true;
        stopBtn.disabled = false;
        downloadBtn.disabled = true;
        playBtn.disabled = true;
      };

      stopBtn.onclick = async () => {
        recording = await recorder.stop();
        startBtn.disabled = false;
        stopBtn.disabled = true;
        downloadBtn.disabled = false;
        playBtn.disabled = false;
      };

      downloadBtn.onclick = () => {
        if (!recording) return;
        const json = JSON.stringify(recording, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'typescript-recording.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      playBtn.onclick = async () => {
        if (!recording) return;
        const speed = parseFloat(speedInput.value) || 1;
        const threshold = parseInt(thresholdInput.value) || 500;
        
        startBtn.disabled = true;
        stopBtn.disabled = true;
        downloadBtn.disabled = true;
        playBtn.disabled = true;
        speedInput.disabled = true;
        thresholdInput.disabled = true;

        try {
          await recorder.play(recording, { speed, minDelayMs: 0, maxDelayMs: threshold });
        } finally {
          startBtn.disabled = false;
          stopBtn.disabled = true;
          downloadBtn.disabled = false;
          playBtn.disabled = false;
          speedInput.disabled = false;
          thresholdInput.disabled = false;
        }
      };
    }

    // Start the demo
    initDemo().catch(console.error);
  </script>
</body>
</html>
