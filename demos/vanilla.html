<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Monaco Recorder Demo (Vanilla)</title>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      .toolbar {
        padding: 0.5rem;
        background: #1e1e1e;
        border-bottom: 1px solid #333;
      }
      #editor {
        height: calc(100vh - 50px);
      }
      button {
        background: #0e639c;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      select {
        background: #1e1e1e;
        color: white;
        border: 1px solid #333;
        padding: 0.5rem;
        border-radius: 4px;
        margin-right: 0.5rem;
      }
    </style>
  </head>
  <body>
    <div class="toolbar">
      <select id="demoSelect">
        <option value="">Select demo...</option>
        <option value="typescript">TypeScript Class</option>
        <option value="react">React Component</option>
      </select>
      <button id="playBtn" disabled>▶ Play</button>
      <button id="stopBtn" disabled>⏹ Stop</button>
      <select id="speedSelect">
        <option value="50">0.5x</option>
        <option value="100" selected>1x</option>
        <option value="200">2x</option>
        <option value="400">4x</option>
      </select>
    </div>
    <div id="editor"></div>

    <script src="https://unpkg.com/monaco-editor@0.45.0/min/vs/loader.js"></script>
    <script type="module">
      let editor = null;
      let monaco = null;
      let recorder = null;
      let recording = null;
      let isPlaying = false;

      // Load Monaco
      window.require.config({ paths: { vs: 'https://unpkg.com/monaco-editor@0.45.0/min/vs' }});
      window.require(['vs/editor/editor.main'], () => {
        window._monacoLoaded = true;
        initDemo();
      });

      async function initDemo() {
        if (!window._monacoLoaded) return;
        monaco = window.monaco;

        // Create editor
        editor = monaco.editor.create(document.getElementById('editor'), {
          value: '// Select a demo from the dropdown...',
          language: 'javascript',
          theme: 'vs-dark',
          automaticLayout: true,
          minimap: { enabled: false }
        });

        // Initialize recorder
        const { createMonacoRecorder } = await import('../monaco-recorder.js');
        recorder = createMonacoRecorder(editor, monaco);

        // Setup UI handlers
        const demoSelect = document.getElementById('demoSelect');
        const playBtn = document.getElementById('playBtn');
        const stopBtn = document.getElementById('stopBtn');
        const speedSelect = document.getElementById('speedSelect');

        demoSelect.addEventListener('change', async (e) => {
          const demo = e.target.value;
          if (!demo) return;
          
          try {
            // Load code
            const codeResponse = await fetch(`../recordings/samples/${demo}.${demo === 'react' ? 'jsx' : 'ts'}`);
            const code = await codeResponse.text();
            
            // Update editor
            const model = monaco.editor.createModel(code, demo === 'react' ? 'javascript' : 'typescript');
            editor.setModel(model);
            
            // Load recording
            const recordingResponse = await fetch(`../recordings/samples/${demo}.json`);
            recording = await recordingResponse.json();
            
            // Enable play
            playBtn.disabled = false;
            stopBtn.disabled = true;
          } catch (err) {
            console.error('Failed to load demo:', err);
          }
        });

        playBtn.addEventListener('click', () => {
          if (isPlaying) {
            recorder.stopPlayback();
            isPlaying = false;
            playBtn.textContent = '▶ Play';
          } else {
            recorder.play(recording.events, {
              speed: (parseInt(speedSelect.value, 10) || 100) / 100,
              minDelayMs: 0,
              maxDelayMs: 1000,
              onDone: () => {
                isPlaying = false;
                playBtn.textContent = '▶ Play';
                stopBtn.disabled = true;
              }
            });
            isPlaying = true;
            playBtn.textContent = '⏸ Pause';
            stopBtn.disabled = false;
          }
        });

        stopBtn.addEventListener('click', () => {
          recorder.stopPlayback();
          isPlaying = false;
          playBtn.textContent = '▶ Play';
          stopBtn.disabled = true;
        });
      }

      // Expose init for AMD callback
      window.initDemo = initDemo;
    </script>
  </body>
</html>
